<div class="mb-6">
  <h1 class="text-2xl font-bold tracking-tight">Analytics dashboard</h1>
  <p class="mt-1 text-slate-300 text-sm">
    See how WhatsApp + AI is converting your leads into customers.
  </p>
</div>

<% if (!metrics) { %>
  <div class="bg-red-900/30 border border-red-700 text-red-200 text-sm rounded-2xl p-4">
    <p><%= error || 'Could not load metrics.' %></p>
  </div>
<% } else { %>

  <!-- TOP KPI CARDS -->
  <div class="grid md:grid-cols-4 gap-4 mb-6">
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <p class="text-xs text-slate-400 mb-1">Total leads</p>
      <p class="text-2xl font-bold text-slate-50"><%= metrics.totalLeads %></p>
      <p class="text-[11px] text-slate-500 mt-1">All sources · last 90 days</p>
    </div>

    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <p class="text-xs text-slate-400 mb-1">Qualified — hot</p>
      <p class="text-2xl font-bold text-rose-300"><%= metrics.hotLeads %></p>
      <p class="text-[11px] text-slate-500 mt-1">Ready to talk to sales</p>
    </div>

    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <p class="text-xs text-slate-400 mb-1">Converted leads</p>
      <p class="text-2xl font-bold text-emerald-300"><%= metrics.convertedLeads %></p>
      <p class="text-[11px] text-slate-500 mt-1">Marked as customers</p>
    </div>

    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <p class="text-xs text-slate-400 mb-1">Conversion rate</p>
      <p class="text-2xl font-bold text-emerald-400"><%= metrics.conversionRate %>%</p>
      <p class="text-[11px] text-slate-500 mt-1">Converted / total leads</p>
    </div>
  </div>

  <!-- MIDDLE: Funnel + Messages -->
  <div class="grid lg:grid-cols-3 gap-4 mb-6">
    <!-- FUNNEL -->
    <div class="lg:col-span-2 bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-slate-100">Lead funnel</h2>
        <p class="text-[11px] text-slate-500">From new to converted</p>
      </div>

      <div class="flex flex-col gap-3 text-xs">
        <div class="flex items-center gap-3">
          <div class="w-24 text-slate-400">Total</div>
          <div class="flex-1 h-2 rounded-full bg-slate-800 overflow-hidden">
            <div class="h-2 bg-slate-300" style="width: 100%"></div>
          </div>
          <div class="w-10 text-right text-slate-200"><%= metrics.totalLeads %></div>
        </div>

        <div class="flex items-center gap-3">
          <div class="w-24 text-slate-400">Hot</div>
          <div class="flex-1 h-2 rounded-full bg-slate-800 overflow-hidden">
            <%
              const hotPct = metrics.totalLeads > 0
                ? Math.max(5, Math.round((metrics.hotLeads / metrics.totalLeads) * 100))
                : 0;
            %>
            <div class="h-2 bg-rose-400" style="width: <%= hotPct %>%"></div>
          </div>
          <div class="w-10 text-right text-rose-300"><%= metrics.hotLeads %></div>
        </div>

        <div class="flex items-center gap-3">
          <div class="w-24 text-slate-400">Warm</div>
          <div class="flex-1 h-2 rounded-full bg-slate-800 overflow-hidden">
            <%
              const warmPct = metrics.totalLeads > 0
                ? Math.max(5, Math.round((metrics.warmLeads / metrics.totalLeads) * 100))
                : 0;
            %>
            <div class="h-2 bg-amber-300" style="width: <%= warmPct %>%"></div>
          </div>
          <div class="w-10 text-right text-amber-200"><%= metrics.warmLeads %></div>
        </div>

        <div class="flex items-center gap-3">
          <div class="w-24 text-slate-400">Cold</div>
          <div class="flex-1 h-2 rounded-full bg-slate-800 overflow-hidden">
            <%
              const coldPct = metrics.totalLeads > 0
                ? Math.max(5, Math.round((metrics.coldLeads / metrics.totalLeads) * 100))
                : 0;
            %>
            <div class="h-2 bg-sky-300" style="width: <%= coldPct %>%"></div>
          </div>
          <div class="w-10 text-right text-sky-200"><%= metrics.coldLeads %></div>
        </div>

        <div class="flex items-center gap-3">
          <div class="w-24 text-slate-400">Converted</div>
          <div class="flex-1 h-2 rounded-full bg-slate-800 overflow-hidden">
            <%
              const convPct = metrics.totalLeads > 0
                ? Math.max(5, Math.round((metrics.convertedLeads / metrics.totalLeads) * 100))
                : 0;
            %>
            <div class="h-2 bg-emerald-400" style="width: <%= convPct %>%"></div>
          </div>
          <div class="w-10 text-right text-emerald-300"><%= metrics.convertedLeads %></div>
        </div>
      </div>
    </div>

    <!-- MESSAGES CARD -->
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <h2 class="text-sm font-semibold text-slate-100 mb-3">Messaging activity</h2>

      <div class="space-y-2 text-xs text-slate-300">
        <div class="flex items-center justify-between">
          <span>Total messages</span>
          <span class="font-semibold text-slate-50"><%= metrics.totalMessages %></span>
        </div>
        <div class="flex items-center justify-between">
          <span>AI / agent messages</span>
          <span class="font-semibold text-emerald-300"><%= metrics.botMessages %></span>
        </div>
        <div class="flex items-center justify-between">
          <span>Lead messages</span>
          <span class="font-semibold text-sky-300"><%= metrics.leadMessages %></span>
        </div>
      </div>

      <div class="mt-4 text-[11px] text-slate-500">
        <p>Shows how much of your lead handling is automated vs manual.</p>
      </div>
    </div>
  </div>

  <!-- BOTTOM: Leads vs Conversions in last 7 days -->
  <div class="grid lg:grid-cols-2 gap-4">
    <!-- Leads in last 7 days -->
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-slate-100">Leads in last 7 days</h2>
        <p class="text-[11px] text-slate-500">Daily lead volume</p>
      </div>

      <div class="flex items-end gap-3 h-40">
        <%
          const maxDay = Math.max(...metrics.last7Days.map(d => d.value), 1);
          metrics.last7Days.forEach(function(d) {
            const h = Math.round((d.value / maxDay) * 100);
        %>
          <div class="flex-1 flex flex-col items-center justify-end gap-1">
            <div class="w-full rounded-t-lg bg-emerald-500/70" style="height: <%= h %>%"></div>
            <div class="text-[10px] text-slate-400"><%= d.label %></div>
            <div class="text-[11px] text-slate-200"><%= d.value %></div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Conversions in last 7 days -->
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-slate-100">Conversions in last 7 days</h2>
        <p class="text-[11px] text-slate-500">Leads marked as customers</p>
      </div>

      <% 
        const convMax = Math.max(...metrics.conversionTrend7Days.map(d => d.value), 1);
      %>

      <div class="flex items-end gap-3 h-40">
        <% metrics.conversionTrend7Days.forEach(function(d) {
             const h = Math.round((d.value / convMax) * 100);
        %>
          <div class="flex-1 flex flex-col items-center justify-end gap-1">
            <div class="w-full rounded-t-lg bg-emerald-400/80" style="height: <%= h %>%"></div>
            <div class="text-[10px] text-slate-400"><%= d.label %></div>
            <div class="text-[11px] text-slate-200"><%= d.value %></div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <!-- LEAD SOURCES -->
  <div class="mt-6 bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-slate-100">Leads by source</h2>
      <p class="text-[11px] text-slate-500">Where your leads are coming from</p>
    </div>

    <% if (!metrics.sourceBreakdown.length) { %>
      <p class="text-xs text-slate-400">No source data yet.</p>
    <% } else { %>
      <div class="flex flex-wrap gap-2 text-[11px]">
        <% metrics.sourceBreakdown.forEach(function(s) { %>
          <span class="px-3 py-1 rounded-full bg-slate-800 text-slate-100 border border-slate-700">
            <%= s.label %> · <span class="text-emerald-300"><%= s.count %></span>
          </span>
        <% }) %>
      </div>
    <% } %>
  </div>

<% } %>
