<div class="flex items-center gap-2 mb-4">
  <form method="POST" action="/leads/<%= lead._id %>/convert">
    <button
      type="submit"
      class="px-3 py-1.5 rounded-xl text-xs font-semibold bg-emerald-500 text-slate-900 hover:bg-emerald-400"
    >
      âœ… Mark as Won
    </button>
  </form>

  <form method="POST" action="/leads/<%= lead._id %>/lost">
    <button
      type="submit"
      class="px-3 py-1.5 rounded-xl text-xs font-semibold bg-rose-500 text-white hover:bg-rose-400"
    >
      âŒ Mark as Lost
    </button>
  </form>

  <% if (lead.stage) { %>
    <span class="ml-2 text-[11px] px-2 py-1 rounded-full bg-slate-800 text-slate-300">
      Stage: <%= lead.stage %>
    </span>
  <% } %>
</div>
<form method="POST" action="/leads/<%= lead._id %>/assign-self">
  <button
    type="submit"
    class="px-3 py-1.5 rounded-xl text-xs font-semibold bg-sky-500 text-white hover:bg-sky-400"
  >
    ğŸ‘¤ Assign to me
  </button>
</form>

<% if (lead.assignedTo) { %>
  <span class="ml-2 text-[11px] px-2 py-1 rounded-full bg-slate-800 text-slate-300">
    Assigned to: 
    <%= (lead.assignedTo.equals && lead.assignedTo.equals(currentUser._id)) ? "You" : "Agent" %>
  </span>
<% } else { %>
  <span class="ml-2 text-[11px] px-2 py-1 rounded-full bg-slate-800 text-slate-400">
    Unassigned
  </span>
<% } %>


<div class="flex items-center justify-between mb-4">
  <div class="flex items-center gap-3">
    <a href="/leads" class="text-xs text-slate-400 hover:text-slate-200">
      â† Back to leads
    </a>
    <span class="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-300">
      WhatsApp conversation
    </span>
  </div>

  <form method="POST" action="/leads/<%= lead._id %>/convert">
    <% if (lead.isConverted) { %>
      <button
        class="text-xs px-3 py-1.5 rounded-xl bg-emerald-500/10 border border-emerald-400 text-emerald-200 hover:bg-emerald-500/20">
        âœ… Marked as customer (click to undo)
      </button>
    <% } else { %>
      <button
        class="text-xs px-3 py-1.5 rounded-xl bg-slate-800 border border-slate-600 text-slate-200 hover:border-emerald-400 hover:text-emerald-200">
        ğŸ’¼ Mark as converted
      </button>
    <% } %>
  </form>
</div>


<div class="flex flex-col lg:flex-row gap-6">

  <!-- LEFT: Lead info -->
  <aside class="lg:w-72 bg-slate-900/70 border border-slate-800 rounded-2xl p-4 text-sm">
    <h2 class="font-semibold text-slate-50 text-base mb-2">
      <%= lead.name || 'Unknown lead' %>
    </h2>

    <% 
      const q = lead.qualificationLevel || "new";
      const pillText = q.toUpperCase();
      let pillClass = "";
      if (q === "hot") pillClass = "bg-rose-500/20 text-rose-300 border border-rose-500/40";
      else if (q === "warm") pillClass = "bg-amber-500/20 text-amber-200 border border-amber-500/40";
      else if (q === "cold") pillClass = "bg-sky-500/20 text-sky-200 border border-sky-500/40";
      else pillClass = "bg-slate-700/60 text-slate-200 border border-slate-600";
    %>

    <div class="flex flex-wrap gap-2 mb-3 text-[11px]">
      <% if (lead.source) { %>
        <span class="px-2 py-1 rounded-full bg-slate-800 text-slate-300">
          <%= lead.source %>
        </span>
      <% } %>
      <span class="px-2 py-1 rounded-full font-semibold <%= pillClass %>">
        <%= pillText %>
      </span>
    </div>

    <div class="space-y-1 text-xs text-slate-300">
      <% if (lead.phone) { %>
        <div>ğŸ“ <%= lead.phone %></div>
      <% } %>
      <% if (lead.email) { %>
        <div>âœ‰ï¸ <%= lead.email %></div>
      <% } %>
      <div class="text-slate-500 mt-2">
        Created: <%= new Date(lead.createdAt).toLocaleString() %>
      </div>

      <% if (lead.isConverted) { %>
  <div class="mt-1 text-[11px] text-emerald-300">
    âœ… Converted on
    <%= lead.convertedAt ? new Date(lead.convertedAt).toLocaleString() : '' %>
  </div>
<% } %>
    </div>

    <div class="mt-4 space-y-2 text-[11px]">
      <% if (lead.budget) { %>
        <div class="px-2 py-1 rounded-full bg-slate-800 text-emerald-300 inline-block">
          Budget: <%= lead.budget %>
        </div>
      <% } %>
      <% if (lead.timeline) { %>
        <div class="px-2 py-1 rounded-full bg-slate-800 text-sky-300 inline-block">
          Timeline: <%= lead.timeline %>
        </div>
      <% } %>
      <% if (lead.useCase) { %>
        <div class="px-2 py-1 rounded-full bg-slate-800 text-violet-300 inline-block">
          Use case: <%= lead.useCase %>
        </div>
      <% } %>
    </div>
  </aside>

  <!-- RIGHT: Conversation -->
  <section class="flex-1 bg-slate-900/70 border border-slate-800 rounded-2xl p-4 flex flex-col">
    <h2 class="font-semibold text-slate-50 text-sm mb-3">Conversation</h2>

    <div class="flex-1 bg-slate-950/70 rounded-xl border border-slate-800 p-3 overflow-y-auto space-y-3 max-h-[480px]">
      <% if (!lead.messages || !lead.messages.length) { %>
        <p class="text-xs text-slate-400">
          No messages stored yet. When the lead or bot sends messages, theyâ€™ll appear here.
        </p>
      <% } else { %>
        <% lead.messages.forEach(function(msg) { %>
          <div class="flex <%= msg.from === 'bot' ? 'justify-end' : 'justify-start' %>">
            <div class="max-w-[70%] rounded-2xl px-3 py-2 text-xs
                        <%= msg.from === 'bot'
                            ? 'bg-emerald-600 text-white rounded-br-sm'
                            : 'bg-slate-800 text-slate-100 rounded-bl-sm' %>">
              <p><%= msg.text %></p>
              <p class="mt-1 text-[10px] opacity-70">
                <%= msg.at ? new Date(msg.at).toLocaleTimeString() : '' %>
                (<%= msg.from === 'bot' ? 'Bot' : 'Lead' %>)
              </p>
            </div>
          </div>
        <% }); %>
      <% } %>
    </div>

       <!-- Reply box: send message from dashboard to WhatsApp -->
    <form method="POST" action="/leads/<%= lead._id %>/reply" class="mt-3 flex gap-2">
      <input
        type="text"
        name="message"
        placeholder="Type a reply to send on WhatsAppâ€¦"
        class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-xs text-slate-100"
        required
      />
      <button
        class="px-4 py-2 text-xs font-semibold rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white"
      >
        Send
      </button>
    </form>

  </section>
</div>
